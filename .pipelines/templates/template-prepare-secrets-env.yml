parameters:
  adminObjectId: ""
  parentDomainName: ""
  parentDomainRg: ""
  pullSecret: ""
  azureTenantId: ""
  azureSubscriptionId: ""
  azureArmClientSecret: ""
  azureArmClientId: ""
  azureFpClientId: ""
  azureClientSecret: ""
  azureClientId: ""
  rgPrefix: ""
  proxyDomainNameLabel: ""
  workingDirectory: ""
  proxyIdRsaPub: ""
  location: ""
steps:
  - script: |
      cd ${{ parameters.workingDirectory }}

      PARENT_DOMAIN_NAME=${{ parameters.parentDomainName }}
      PARENT_DOMAIN_RESOURCEGROUP=${{ parameters.parentDomainRg }}
      ADMIN_OBJECT_ID=${{ parameters.adminObjectId }}
      PULL_SECRET=$(echo ${{ parameters.pullSecret }} | base64 -d)
      AZURE_TENANT_ID=${{ parameters.azureTenantId }}
      AZURE_SUBSCRIPTION_ID=${{ parameters.azureSubscriptionId }}
      AZURE_ARM_CLIENT_SECRET=$(echo ${{ parameters.azureArmClientSecret }} | base64 -d)
      AZURE_ARM_CLIENT_ID=${{ parameters.azureArmClientId }}
      AZURE_FP_CLIENT_ID=${{ parameters.azureFpClientId }}
      AZURE_CLIENT_SECRET=$(echo ${{ parameters.azureClientSecret }} | base64 -d)
      AZURE_CLIENT_ID=${{ parameters.azureClientId }}
      LOCATION=${{ parameters.location }}
      RESOURCEGROUP_PREFIX=${{ parameters.rgPrefix }}
      PROXY_DOMAIN_NAME_LABEL=${{ parameters.proxyDomainNameLabel }}
      DATABASE_NAME=$(Build.SourceVersion)

      cat >secrets/env <<EOF
      export AZURE_TENANT_ID='$AZURE_TENANT_ID'
      export AZURE_SUBSCRIPTION_ID='$AZURE_SUBSCRIPTION_ID'
      export AZURE_ARM_CLIENT_ID='$AZURE_ARM_CLIENT_ID'
      export AZURE_ARM_CLIENT_SECRET='$AZURE_ARM_CLIENT_SECRET'
      export AZURE_FP_CLIENT_ID='$AZURE_FP_CLIENT_ID'
      export AZURE_CLIENT_ID='$AZURE_CLIENT_ID'
      export AZURE_CLIENT_SECRET='$AZURE_CLIENT_SECRET'
      export RESOURCEGROUP="$RESOURCEGROUP_PREFIX-\$LOCATION"
      export PROXY_HOSTNAME="vm0.$PROXY_DOMAIN_NAME_LABEL.\$LOCATION.cloudapp.azure.com"
      export PULL_SECRET='$PULL_SECRET'
      export RP_MODE='development'
      export DATABASE_NAME='$DATABASE_NAME'
      ADMIN_OBJECT_ID='$ADMIN_OBJECT_ID'
      COSMOSDB_ACCOUNT="\$RESOURCEGROUP"
      DOMAIN_NAME="\$RESOURCEGROUP"
      KEYVAULT_PREFIX="\$RESOURCEGROUP"
      PARENT_DOMAIN_NAME='$PARENT_DOMAIN_NAME'
      PARENT_DOMAIN_RESOURCEGROUP='$PARENT_DOMAIN_RESOURCEGROUP'
      EOF

      echo ${{ parameters.proxyIdRsaPub }} | base64 -d > secrets/proxy_id_rsa.pub

      . secrets/env
    displayName: "ğŸŒ± Prepare secrets env"
